<!DOCTYPE html>
<html>

<head>
    <title>
        <%= title %>
    </title>
    <% include ./include/header %>
</head>

<body>
    <!-- <% include ./include/navBarUser %> -->
    <form class="form-inline" name="search" action="javascript:void()" onsubmit="searchFood();">
        <div class="col-3">
            <div class="custom-control custom-radio">
                <input type="radio" class="custom-control-input" id="foodName" name="searchOption" value="foodName" checked>
                <label class="custom-control-label" for="foodName">T√™n m√≥n</label>
            </div>
            <div class="custom-control custom-radio">
                <input type="radio" class="custom-control-input" id="courtName" name="searchOption" value="courtName">
                <label class="custom-control-label" for="courtName">T√™n c·ª≠a h√†ng</label>
            </div>
            <div class="custom-control custom-radio">
                <input type="radio" class="custom-control-input" id="foodType" name="searchOption" value="foodType">
                <label class="custom-control-label" for="foodType">Lo·∫°i m√≥n</label>
            </div>
        </div>
        <div class="col-9">
            <input class="form-control mr-sm-2" type="text" name="searchText" placeholder="Search">
            <button class="btn btn-success" type="submit">Search</button>
        </div>
    </form>

    <ul id="foodList" class="list-group">
        <li class="list-group-item">
            <img src="/images/food/9.jpg" class="mx-auto d-block foodImage">
            <p class="foodId">üîπ 7</p>
            <p class="foodName">üëâ Anh Hu·∫•n</p>
            <p class="foodPrice">üí∏ 5000ƒë</p>
            <p class="foodDescription">‚ùï Hu·∫•n l√†m ƒë√≥ nha</p>
            <button class="btn btn-primary" onclick="addFood(7);">‚úî Th√™m v√†o gi·ªè h√†ng</button>
        </li>
    </ul>

    <div id="cart" onclick="showCart();">
        üõí
    </div>

    <div id="myModal" class="modal">

        <!-- Modal content -->
        <div class="modal-content">
            <div>
                <h5>Gi·ªè h√†ng</h5>
            </div>
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>ƒê∆°n gi√°</th>
                        <th>S·ªë l∆∞·ª£ng</th>
                        <th>Th√†nh ti·ªÅn</th>
                    </tr>
                </thead>
                <tbody id="foodChosen">
                    <tr>
                        <td>1</td>
                        <td>C∆°m</td>
                        <td>10000</td>
                        <td>2</td>
                        <td>20000</td>
                    </tr>

                    <tr class="table-primary">
                        <td>T·ªïng c·ªông</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td>20000</td>
                    </tr>
                </tbody>
            </table>
            <div>
                <button class="btn btn-primary" onclick="window.location.href='/order'">ƒê·∫∑t h√†ng</button>
                <button class="btn btn-danger" onclick="deleteCart();">X√≥a gi·ªè h√†ng</button>
                <button class="btn btn-secondary" onclick="closeModal();">H·ªßy</button>
            </div>
        </div>

    </div>
</body>
<script>
    var FOOD_LIST = [];

    function renderFood(arr) {
        FOOD_LIST = arr;
        let foodList = $("#foodList");
        foodList.empty();
        let len = arr.length;
        for (let i = 0; i < len; i++)
            if (arr[i].available) {
                foodList.append('<li class="list-group-item">\
                                    <img src="/images/food/' + arr[i].id + '.jpg" class="mx-auto d-block foodImage">\
                                    <p class="foodId">üîπ ' + arr[i].id + '</p>\
                                    <p class="foodName">üëâ ' + arr[i].name + '</p>\
                                    <p class="foodPrice">üí∏ ' + arr[i].price + '</p>\
                                    <p class="foodDescription">‚ùï ' + arr[i].description + '</p>\
                                    <button class="btn btn-primary" onclick="addFood(' + i + ');">‚úî Th√™m v√†o gi·ªè h√†ng</button>\
                                </li>');
            }
    }

    function searchFood() {
        if (document.search.searchOption.value && document.search.searchText.value != '') {
            let searchOption = document.search.searchOption.value;
            $.post("/food", {
                    target: searchOption,
                    value: document.search.searchText.value
                },
                function(arr, status) {
                    //console.log(arr);
                    if (status == 'success' && arr) {
                        renderFood(arr);
                    }
                });
        }
    }

    function getAllFood() {
        $.post("/food", {
                target: "all"
            },
            function(arr, status) {
                //console.log(arr);
                if (status == 'success' && arr) {
                    renderFood(arr);
                }
            });
    }

    function addFood(index) {
        let cartString = localStorage.getItem("cart");
        let cart = {};
        try {
            cart = JSON.parse(cartString);
        } catch (e) {
            //alert('catch 1 err');
            cart = {};
        }
        if (!cart) {
            cart = {};
        }
        try {
            food = FOOD_LIST[index];
            if (!cart["" + food.id]) {
                cart["" + food.id] = {
                    name: food.name,
                    price: food.price,
                    count: 1
                }
            } else {
                cart["" + food.id].count += 1;
            }
            localStorage.setItem("cart", JSON.stringify(cart));
        } catch (e) {
            //alert('catch 2 err');
            cart = {}
        }
    }

    function deleteCart() {
        localStorage.removeItem("cart");
        closeModal();
    }

    function showCart() {
        let cartString = localStorage.getItem("cart");
        let cart = {};
        try {
            cart = JSON.parse(cartString);

            if (!cart) {
                cart = {};
            }
            let foodChosen = $("#foodChosen");
            foodChosen.empty();
            let amount = 0;
            let empty = true;
            for (let key in cart)
                if (cart[key].count > 0) {
                    empty = false;
                    amount += cart[key].price * cart[key].count;
                    foodChosen.append('<tr>\
                            <td>' + key + '</td>\
                            <td>' + cart[key].name + '</td>\
                            <td>' + cart[key].price + '</td>\
                            <td>' + cart[key].count + '</td>\
                            <td>' + cart[key].price * cart[key].count + '</td>\
                        </tr>');
                }
            if (empty) {
                foodChosen.append('<tr class="table-warning"><td>Gi·ªè h√†ng r·ªóng</td><td></td><td></td><td></td><td></td></tr>');
            } else {
                foodChosen.append('<tr class="table-primary">\
                                <td></td>\
                                <td></td>\
                                <td></td>\
                                <td><strong>T·ªïng c·ªông</strong></td>\
                                <td><strong>' + amount + '</strong></td>\
                            </tr>');
            }
        } catch (e) {
            alert('catch 1 err');
            cart = {};
        }


        openModal();
    }

    function openModal() {
        // When the user clicks on <span> (x), close the modal
        modal.style.display = "block";
    }

    function closeModal() {
        // When the user clicks on <span> (x), close the modal
        modal.style.display = "none";
    }

    // Get the modal
    var modal = document.getElementById("myModal");
    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
    getAllFood();
</script>

</html>